<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iran Chat - Secure Local Messaging</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Login/Register Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h1>Iran Chat</h1>
            <p class="tagline">Secure Local Messaging</p>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>Login</h2>
                <form onsubmit="handleLogin(event)">
                    <input type="text" id="loginUsername" placeholder="@username" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
                <div id="loginError" class="error"></div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <h2>Register</h2>
                <form onsubmit="handleRegister(event)">
                    <input type="text" id="regUsername" placeholder="@username" required pattern="@[a-zA-Z0-9_]{3,}">
                    <input type="text" id="regDisplayName" placeholder="Display Name" required>
                    <input type="password" id="regPassword" placeholder="Password (8+ chars)" required minlength="8">
                    <div class="password-hint">Password must be 8+ characters with uppercase, lowercase, number, and special character</div>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
                <div id="registerError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- User Info -->
            <div id="userInfo" class="user-info"></div>
            
            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search users..." onkeyup="handleSearch(event)">
                <button onclick="addFriend()" class="add-friend-btn" title="Add Friend">+</button>
            </div>
            
            <!-- Friends List -->
            <div id="friendsList" class="friends-list"></div>
            
            <!-- Search Results -->
            <div id="searchResults" class="search-results hidden"></div>
        </div>
        
        <!-- Chat Area -->
        <div id="chatArea" class="chat-area hidden">
            <!-- Chat Header -->
            <div id="chatHeader" class="chat-header"></div>
            
            <!-- Messages -->
            <div id="messages" class="messages"></div>
            
            <!-- Message Input -->
            <div class="message-input-container">
                <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)" disabled>
                <button onclick="sendMessage()" disabled id="sendBtn">Send</button>
            </div>
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">â˜°</button>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/chat.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let socket = null;

        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, checking auth status...');
            if (Auth.isLoggedIn()) {
                console.log('User is logged in, initializing chat...');
                currentUser = Auth.getCurrentUser();
                showChatInterface();
                initChat();
            } else {
                console.log('User not logged in, showing auth form...');
                showAuthInterface();
            }
        });

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            console.log('Login attempt...');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Ensure username starts with @
            const formattedUsername = username.startsWith('@') ? username : '@' + username;
            
            console.log('Attempting login for:', formattedUsername);
            
            const result = await Auth.login(formattedUsername, password);
            
            if (result.success) {
                console.log('Login successful:', result.user);
                currentUser = result.user;
                showChatInterface();
                initChat();
                clearError('loginError');
            } else {
                console.log('Login failed:', result.error);
                showError('loginError', result.error);
            }
        }

        // Handle register
        async function handleRegister(event) {
            event.preventDefault();
            console.log('Register attempt...');
            
            const username = document.getElementById('regUsername').value.trim();
            const displayName = document.getElementById('regDisplayName').value.trim();
            const password = document.getElementById('regPassword').value;
            
            // Ensure username starts with @
            const formattedUsername = username.startsWith('@') ? username : '@' + username;
            
            console.log('Attempting registration for:', formattedUsername);
            
            const result = await Auth.register(formattedUsername, displayName, password);
            
            if (result.success) {
                console.log('Registration successful:', result.user);
                currentUser = result.user;
                showChatInterface();
                initChat();
                clearError('registerError');
            } else {
                console.log('Registration failed:', result.error);
                showError('registerError', result.error);
            }
        }

        // UI helpers
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            clearError('loginError');
            clearError('registerError');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearError('loginError');
            clearError('registerError');
        }

        function showAuthInterface() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
        }

        function showChatInterface() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        function clearError(elementId) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleSearch(event) {
            const query = event.target.value;
            if (query.length > 2) {
                searchUsers(query);
            } else {
                document.getElementById('searchResults').classList.add('hidden');
            }
        }

        function displaySearchResults(users) {
            const resultsEl = document.getElementById('searchResults');
            resultsEl.innerHTML = '';
            
            if (users.length === 0) {
                resultsEl.innerHTML = '<p class="no-results">No users found</p>';
            } else {
                users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'search-result-item';
                    userEl.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${user.display_name}</div>
                            <div class="user-username">${user.username}</div>
                        </div>
                        <button onclick="addFriendByUsername('${user.username}')" class="add-btn">Add</button>
                    `;
                    resultsEl.appendChild(userEl);
                });
            }
            
            resultsEl.classList.remove('hidden');
        }

        function addFriendByUsername(username) {
            if (socket) {
                socket.emit('add_friend', { friendUsername: username });
                document.getElementById('searchResults').classList.add('hidden');
                document.getElementById('searchInput').value = '';
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Override logout to use Auth module
        function logout() {
            Auth.logout();
        }
    </script>
</body>
</html>