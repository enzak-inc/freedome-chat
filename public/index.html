<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iran Chat - Secure Local Messaging</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Login/Register Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h1>Iran Chat</h1>
            <p class="tagline">Secure Local Messaging</p>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>Login</h2>
                <form onsubmit="handleLogin(event)">
                    <input type="text" id="loginUsername" placeholder="@username" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
                <div id="loginError" class="error"></div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <h2>Register</h2>
                <form onsubmit="handleRegister(event)">
                    <input type="text" id="regUsername" placeholder="@username" required pattern="@[a-zA-Z0-9_]{3,}">
                    <input type="text" id="regDisplayName" placeholder="Display Name" required>
                    <input type="password" id="regPassword" placeholder="Password (8+ chars)" required minlength="8">
                    <div class="password-hint">Password must be 8+ characters with uppercase, lowercase, number, and special character</div>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
                <div id="registerError" class="error"></div>
            </div>
        </div>
    </div>

    <!-- Main Chat Container -->
    <div id="chatContainer" class="chat-container hidden">
        <!-- Conversations View -->
        <div id="conversationsView" class="conversations-view active">
            <!-- iOS Status Bar -->
            <div class="ios-status-bar">
                <span class="status-time" id="statusTime"></span>
                <div class="status-icons">
                    <span class="signal">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                    <span class="wifi">üì∂</span>
                    <span class="battery">üîã</span>
                </div>
            </div>
            
            <!-- Navigation Bar -->
            <div class="ios-nav-bar">
                <h1 class="nav-title">Messages</h1>
                <button class="edit-btn" onclick="toggleEditMode()">Edit</button>
            </div>
            
            <!-- Search Bar -->
            <div class="ios-search-container">
                <div class="ios-search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search" onkeyup="handleSearch(event)">
                    <button class="cancel-search hidden" onclick="cancelSearch()">Cancel</button>
                </div>
                <button class="compose-new-btn" onclick="addFriend()" title="New Message">
                    <span style="font-size: 20px;">‚úèÔ∏è</span>
                </button>
            </div>
            
            <!-- Conversations List -->
            <div class="conversations-scroll">
                <div id="friendsList" class="ios-conversations-list"></div>
            </div>
            
            <!-- Search Results Overlay -->
            <div id="searchResults" class="search-results-overlay hidden"></div>
        </div>
        
        <!-- Chat View -->
        <div id="chatView" class="chat-view">
            <!-- iOS Status Bar -->
            <div class="ios-status-bar">
                <span class="status-time" id="chatStatusTime"></span>
                <div class="status-icons">
                    <span class="signal">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                    <span class="wifi">üì∂</span>
                    <span class="battery">üîã</span>
                </div>
            </div>
            
            <!-- Chat Navigation Bar -->
            <div class="ios-chat-nav">
                <button class="ios-back-btn" onclick="backToConversations()">
                    <span class="back-arrow">‚Äπ</span>
                    <span class="back-text">Messages</span>
                </button>
                <div class="chat-nav-center">
                    <div id="chatTitleName" class="chat-contact-name"></div>
                    <div id="chatTitleUsername" class="chat-contact-username"></div>
                </div>
                <button class="chat-info-btn">‚ìò</button>
            </div>
            
            <!-- Messages Container -->
            <div id="messages" class="ios-messages-container"></div>
            
            <!-- Message Input Bar -->
            <div class="ios-message-input-bar">
                <button class="attach-btn">+</button>
                <div class="ios-input-wrapper">
                    <input type="text" id="messageInput" placeholder="iMessage" onkeypress="handleMessageKeypress(event)" disabled>
                </div>
                <button onclick="sendMessage()" disabled id="sendBtn" class="ios-send-btn">‚Üë</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/chat.js"></script>
    <script>
        // Global variables are declared in chat.js

        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, checking auth status...');
            
            // Check for logout parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout')) {
                // Clear any remaining cache and ensure logout
                localStorage.clear();
                console.log('Logout detected, clearing all cache...');
            }
            
            if (Auth.isLoggedIn()) {
                console.log('User is logged in, initializing chat...');
                currentUser = Auth.getCurrentUser();
                showChatInterface();
                initChat();
            } else {
                console.log('User not logged in, showing auth form...');
                showAuthInterface();
                // Clear forms safely
                setTimeout(() => {
                    const loginUsernameEl = document.getElementById('loginUsername');
                    const loginPasswordEl = document.getElementById('loginPassword');
                    if (loginUsernameEl) loginUsernameEl.value = '';
                    if (loginPasswordEl) loginPasswordEl.value = '';
                    clearError('loginError');
                    clearError('registerError');
                }, 50);
            }
        });

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            console.log('Login attempt...');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Ensure username starts with @
            const formattedUsername = username.startsWith('@') ? username : '@' + username;
            
            console.log('Attempting login for:', formattedUsername);
            
            const result = await Auth.login(formattedUsername, password);
            
            if (result.success) {
                console.log('Login successful:', result.user);
                currentUser = result.user;
                showChatInterface();
                initChat();
                clearError('loginError');
            } else {
                console.log('Login failed:', result.error);
                showError('loginError', result.error);
            }
        }

        // Handle register
        async function handleRegister(event) {
            event.preventDefault();
            console.log('Register attempt...');
            
            const username = document.getElementById('regUsername').value.trim();
            const displayName = document.getElementById('regDisplayName').value.trim();
            const password = document.getElementById('regPassword').value;
            
            // Ensure username starts with @
            const formattedUsername = username.startsWith('@') ? username : '@' + username;
            
            console.log('Attempting registration for:', formattedUsername);
            
            const result = await Auth.register(formattedUsername, displayName, password);
            
            if (result.success) {
                console.log('Registration successful:', result.user);
                currentUser = result.user;
                showChatInterface();
                initChat();
                clearError('registerError');
            } else {
                console.log('Registration failed:', result.error);
                showError('registerError', result.error);
            }
        }

        // UI helpers
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            clearError('loginError');
            clearError('registerError');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearError('loginError');
            clearError('registerError');
        }

        function showAuthInterface() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
        }

        function showChatInterface() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            updateUserTabInfo();
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
            }
        }

        function clearError(elementId) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleSearch(event) {
            const query = event.target.value;
            const cancelBtn = document.querySelector('.cancel-search');
            
            if (query.length > 0) {
                cancelBtn.classList.remove('hidden');
                if (query.length > 2) {
                    searchUsers(query);
                }
            } else {
                cancelBtn.classList.add('hidden');
                document.getElementById('searchResults').classList.add('hidden');
            }
        }

        function cancelSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelector('.cancel-search').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
        }

        function displaySearchResults(users) {
            const resultsEl = document.getElementById('searchResults');
            resultsEl.innerHTML = '';
            
            if (users.length === 0) {
                resultsEl.innerHTML = '<p class="no-results">No users found</p>';
            } else {
                users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'search-result-item';
                    userEl.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${user.display_name}</div>
                            <div class="user-username">${user.username}</div>
                        </div>
                        <button onclick="addFriendByUsername('${user.username}')" class="add-btn">Add</button>
                    `;
                    resultsEl.appendChild(userEl);
                });
            }
            
            resultsEl.classList.remove('hidden');
        }

        function addFriendByUsername(username) {
            if (socket) {
                socket.emit('add_friend', { friendUsername: username });
                cancelSearch();
            }
        }

        function backToConversations() {
            const conversationsView = document.getElementById('conversationsView');
            const chatView = document.getElementById('chatView');
            
            conversationsView.classList.add('active');
            chatView.classList.remove('active');
            
            // Clear selected chat
            selectedChat = null;
            document.querySelectorAll('.conversation-item').forEach(el => {
                el.classList.remove('active');
            });
        }
        
        function toggleEditMode() {
            // Create a simple action sheet for logout
            if (confirm('Do you want to logout?')) {
                logout();
            }
        }
        
        function updateStatusTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const statusTimeEl = document.getElementById('statusTime');
            const chatStatusTimeEl = document.getElementById('chatStatusTime');
            
            if (statusTimeEl) statusTimeEl.textContent = timeString;
            if (chatStatusTimeEl) chatStatusTimeEl.textContent = timeString;
        }
        
        // Update time every minute
        setInterval(updateStatusTime, 60000);
        updateStatusTime();

        function updateUserTabInfo() {
            if (currentUser) {
                const avatarEl = document.getElementById('userAvatar');
                const nameEl = document.getElementById('userName');
                
                if (avatarEl) {
                    avatarEl.textContent = currentUser.displayName[0].toUpperCase();
                }
                if (nameEl) {
                    nameEl.textContent = currentUser.displayName;
                }
            }
        }

        // Override logout to use Auth module
        function logout() {
            Auth.logout();
        }
        
        // Override selectChat for iOS navigation
        window.selectChat = function(username, displayName) {
            selectedChat = username;
            
            // Switch views
            const conversationsView = document.getElementById('conversationsView');
            const chatView = document.getElementById('chatView');
            
            conversationsView.classList.remove('active');
            chatView.classList.add('active');
            
            // Update chat header
            const chatTitleName = document.getElementById('chatTitleName');
            const chatTitleUsername = document.getElementById('chatTitleUsername');
            
            if (chatTitleName) chatTitleName.textContent = displayName;
            if (chatTitleUsername) chatTitleUsername.textContent = username;
            
            // Enable message input
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (messageInput && sendBtn) {
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.placeholder = 'iMessage';
            }
            
            // Load messages
            loadMessages(username);
        };
    </script>
</body>
</html>